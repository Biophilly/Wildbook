<html><head>
<script src="//code.jquery.com/jquery-3.5.1.min.js"></script>
<title>next-gen edm test</title>

<script>
var d = new Date();
var occJson = {};
occJson.decimalLatitude = (0.5 - Math.random()) * 100;
occJson.startTime = d.toISOString();
occJson.endTime = new Date(d.getTime() + (24.1234*3600000)).toISOString();
occJson.submissionContentReferences = [];
occJson.submissions = [];

function init() {
	refreshOccJsonForm();
}

function refreshOccJsonForm() {
	$('#occ-json').val(JSON.stringify(occJson, null, 4));
}

/*

        curl \
            -L -s -X POST \
            -b cookie.jar \
            -F title="Test Submission $TIMESTAMP" \
            -F description="This is a test submission (via CURL), please ignore" \
            -F files="@/home/jon/chopstix.jpg" \
            -F files="@/home/jon/rnd-fluke.jpg" \
            https://nextgen.dev-wildbook.org/api/v1/submissions/streamlined

*/
var formData;
function sendSubmission() {
	$('#send-sub-button').hide();
	formData = new FormData(document.getElementById('files-form'));
	formData.append('title', 'upload test ' + d.toLocaleString());
	formData.append('description', navigator.userAgent);

	//build out submissionContentReferences (for occurrence)
	var scrs = [];
	jQuery.each(jQuery('#files')[0].files, function(i, file) {
		console.log('file %d => %o', i, file);
		scrs.push({
			filename: file.name,
			filesize: file.size
		});
	});

	jQuery.ajax({
		url: '/api/v1/submissions/streamlined',
    		data: formData,
    		cache: false,
    		contentType: false,
    		processData: false,
    		method: 'POST',
    		success: function(rtn){
			console.log('success!!! %o', rtn);
			var sid = rtn.guid
			occJson.submissions.push(sid);
			for (var i = 0 ; i < scrs.length ; i++) {
				scrs[i].submissionId = sid;
			}
			occJson.submissionContentReferences = occJson.submissionContentReferences.concat(scrs);
			refreshOccJsonForm();
			$('#send-sub-button').hide();
		}
	});

}
function sendOcc() {
	occJson = JSON.parse($('#occ-json').val());
	console.info('occJson = %o', occJson);
	jQuery.ajax({
		url: '/api/v0/org.ecocean.Occurrence',
		method: 'POST',
		data: JSON.stringify(occJson),
		dataType: 'json',
		success: function(rtn) {
			console.log('success!!! %o', rtn);
			var h = '';
			if (rtn && rtn.success && rtn.result) {
				h += 'created <a target="_new" href="/api/v0/org.ecocean.Occurrence/' + rtn.result.id + '?detail-org.ecocean.Occurrence=max">' + rtn.result.id + '</a>';
				h += '<xmp>' + JSON.stringify(rtn, null, 8) + '</xmp>';
			} else {
				h += '<b>failed?</b>';
			}
			$('#occ-result').html(h);
		}
	});
}
</script>

</head><body onLoad="init();" >

<form id="files-form">
<input type="file" multiple="true" id="files" name="files" />
</form>

<br /><input id="send-sub-button" type="button" value="send file(s)" onClick="sendSubmission()" />

<hr />

<textarea id="occ-json" name="occ-json" style="width: 50%; height: 50em;" >
</textarea>

<br />

<input type="button" value="create Occurrence" onClick="sendOcc()" />

<div id="occ-result">
</div>

</body>
</html>
